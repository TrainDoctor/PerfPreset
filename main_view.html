<html>

<head>
    <link rel="stylesheet" href="/steam_resource/css/2.css">
    <link rel="stylesheet" href="/steam_resource/css/39.css">
    <link rel="stylesheet" href="/steam_resource/css/library.css">
    <script src="/static/library.js"></script>
    <script>
        // Python Functions
        //file is a filepath including suffix to the location of a vdf file
        // function getVDF(file) {
        //     return call_plugin_method("get_vdf", {
        //         "file": file
        //     });
        // }

        async function getGame() {
            return call_plugin_method("get_game", {});
        }

        async function getSettings() {
            return call_plugin_method("get_settings", {});
        }

        async function prettySettings(obj) {
            return call_plugin_method("pretty_settings", {
                "obj": obj
            });
        }
        
        async function savePreset() {
            return call_plugin_method("save_preset", {});
        }

        async function loadPreset() {
            console.log("Attempted to load a preset!")
            console.log("Attempting to run Zenity")
            let scid = await call_plugin_method("zenityid", {"mode": "get"});
            console.log(scid)
            let gameid = await getGameID(scid);
            // let gameid = await ap(`GetAppOverviewByAppID(${scid})`)
            console.log(gameid)
            sc(`Apps.RunGame("${gameid}","",-1,100)`);
        }

        //Non-python
        async function sc(action) {
            return execute_in_tab("SP", true, `SteamClient.${action}`);
        }

        async function getGameID(shortcutid) {
            let game = (await execute_in_tab("SP", true, `
                    async function get_gameid() {
                        let res = await appStore.GetAppOverviewByAppID(${shortcutid})
                        return JSON.stringify(res)
                    }
                    
                    get_gameid()
            `)).result;
            if (game != "null") {
                game = JSON.parse(game);
                return game.m_gameid;
            } else {
                return -1
            }
        }

        async function createZenityShortcut() {
            let exists = await call_plugin_method("zenityid", { "mode": "exists"});
            if (!exists) {
                let id = (await sc('Apps.AddShortcut("Zenity","/usr/bin/zenity")')).result;
                logfile = "/home/deck/.config/pluginloader/perfpresets/zenity.log"
                call_plugin_method("zenityid", {"mode":"create", "id": id});
                sc(`Apps.SetShortcutLaunchOptions(${id}, "--file-selection | ${logfile}")`);
            }
            else console.log("Zenity Shortcut already exists.")
        }

        async function showCurrentSettings() {
            document.getElementById("actsetdisplay").innerHTML = 
                                        await prettySettings(await getSettings());
        }
        
        async function showCurrentGame() {
            info = await getGame();
            if (info.id == "0") {
                document.getElementById("actgamedisplay").innerHTML = info.name + "<br>"+ info.id;
            } 
            else {
                document.getElementById("actgamedisplay").innerHTML = info.name.toString() + ": " + info.id.toString();
            }
        }

        async function autoPopulate() {
            await showCurrentSettings();
            await showCurrentGame();
        }

        createZenityShortcut();

        window.setInterval('autoPopulate()', 500);
    </script>
    <style type="text/css" media="screen"></style>
</head>

<body onload="autoPopulate()">
    <div class="quickaccessmenu_TabGroupPanel_1QO7b Panel Focusable">
        <div class="quickaccesscontrols_PanelSectionRow_26R5w">
            <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                <div class="basicdialog_FieldLabel_2URP7" style="text-align:center;">
                    Active Game:
                </div>
                <div id="actgamedisplay" style="text-align:center;" onclick="showCurrentGame()">
                    Placeholder
                </div>
                <!-- TODO: Confirm overwrite dialog -->
                <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable"
                    style="--indent-level:0;">
                    <div class="gamepaddialog_FieldChildren_2rhav">
                        <button type="button" onclick="savePreset()"
                            class="DialogButton _DialogLayout Secondary gamepaddialog_Button_cXzBZ Focusable"
                            tabindex="0">
                            Save Settings
                        </button>
                    </div>
                </div>
                <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable"
                    style="--indent-level:0;">
                    <div class="gamepaddialog_FieldChildren_2rhav">
                        <button type="button" onclick="loadPreset()"
                            class="DialogButton _DialogLayout Secondary gamepaddialog_Button_cXzBZ Focusable"
                            tabindex="0">
                            Load Settings
                        </button>
                    </div>
                </div>
                <div class="gamepaddialog_Field_eKmEX gamepaddialog_WithFirstRow_2bDqk gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_WithBottomSeparator_3YKpU gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable"
                    style="--indent-level:0;">
                    <div class="gamepaddialog_FieldChildren_2rhav" onclick="showCurrentSettings()">
                        <div class="basicdialog_FieldLabel_2URP7">
                            Current Settings:
                        </div>
                    </div>
                </div>
                <div id="actsetdisplay"></div>
            </div>
        </div>
    </div>
</body>

</html>